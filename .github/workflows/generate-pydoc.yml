name: Projecte Django M3-UF6 – Genera Pydoc i publica GH-Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Apply migrations & run tests
        run: |
          python manage.py migrate
          python manage.py test

      - name: Generate Pydoc documentation
        env:
          DJANGO_SETTINGS_MODULE: my_site.settings
          PYTHONPATH: ${{ github.workspace }}
        run: |
          mkdir -p docs
          python - << 'PYDOC'
import os
import django
import pydoc

# 1) Configura Django
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "my_site.settings")
django.setup()

# 2) Carpeta de destí
docs_dir = os.path.join(os.getcwd(), "docs")
os.makedirs(docs_dir, exist_ok=True)

# 3) Mòduls a documentar
modules = [
    "blog.models",
    "blog.views",
    "blog.urls",
    "blog.admin",
    "blog.tests",
]

# 4) Genera un HTML per cada mòdul
for mod in modules:
    print(f"– Generant doc per {mod}")
    pydoc.writedoc(mod)  # crea e.g. 'blog.models.html'
    src = f"{mod}.html"
    dst = os.path.join(docs_dir, mod.split(".")[-1] + ".html")
    if os.path.exists(src):
        os.replace(src, dst)
    else:
        print(f"⚠️ No trobat {src}")

# 5) Documenta el paquet arrel i crea index.html
print("– Generant doc per paquet blog")
pydoc.writedoc("blog")  # crea 'blog.html'
if os.path.exists("blog.html"):
    os.replace("blog.html", os.path.join(docs_dir, "index.html"))
PYDOC

      - name: Deploy to GitHub Pages (gh-pages)
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: docs
