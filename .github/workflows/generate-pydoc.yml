name: Projecte Django ‚Äì Oriol Torra

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-doc:
    runs-on: ubuntu-latest

    steps:
      - name: Clona el repositori
        uses: actions/checkout@v3

      - name: Configura Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Instal¬∑la depend√®ncies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Aplica migracions
        run: python manage.py migrate

      - name: Executa tests
        run: python manage.py test

      - name: Genera Pydoc
        env:
          DJANGO_SETTINGS_MODULE: my_site.settings
          PYTHONPATH: ${{ github.workspace }}
        run: |
          mkdir -p docs
          # Genera un HTML per a cada m√≤dul .py
          for file in $(find . -name "*.py" ! -path "./venv/*" ! -path "./*/migrations/*"); do
            module=${file#./}               # treu el prefix ./
            module=${module%.py}            # treu l‚Äôextensi√≥
            module=${module//\//.}          # converteix rutes en punts
            echo "Generant doc per $module"
            pydoc -w "$module" || echo "‚ö†Ô∏è Error amb $module"
          done
          mv *.html docs/ || true

          # Crea l‚Äô√≠ndex de la documentaci√≥
          echo "# üìö Documentaci√≥ Pydoc" > docs/index.html
          for f in docs/*.html; do
            name=$(basename "$f")
            echo "- [$name]($name)" >> docs/index.html
          done

      - name: Publica a GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: docs

      - name: Actualitza README.md amb enlla√ß
        run: |
          LINK="[üìö Documentaci√≥ Pydoc](https://OriolTorraTudela.github.io/Projecte-Final_Django/)"
          if ! grep -q "Documentaci√≥ Pydoc" README.md; then
            echo -e "\n$LINK" >> README.md
            git config --global user.name "github-actions"
            git config --global user.email "github-actions@github.com"
            git add README.md
            git commit -m "Afegit enlla√ß Pydoc al README"
            git push origin main
          fi
