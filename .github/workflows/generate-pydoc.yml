# .github/workflows/generate-pydoc.yml
name: Projecte Django ‚Äì Oriol Torra

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Clona el repositori
        uses: actions/checkout@v3

      - name: Configura Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Instal¬∑la depend√®ncies
        run: |
          python -m pip install --upgrade pip
          pip install Django
          pip install -r requirements.txt

      - name: Aplica migracions i executa tests
        run: |
          python manage.py migrate
          python manage.py test

      - name: Genera documentaci√≥ amb Pydoc
        env:
          DJANGO_SETTINGS_MODULE: my_site.settings
          PYTHONPATH: ${{ github.workspace }}
        run: |
          # Torna a assegurar-te que Django est√† instal¬∑lat
          python -m pip install Django

          mkdir -p docs
          for file in $(find . -name "*.py" ! -path "./venv/*" ! -path "./*/migrations/*"); do
            module=${file#./}                 # treu el prefix "./"
            module=${module%.py}              # treu l'extensi√≥
            module=${module//\//.}            # converteix rutes en punts
            echo "Generant doc per $module"
            pydoc -w "$module" || echo "‚ö†Ô∏è Error amb $module"
          done
          mv *.html docs/ || true

          # Crea l'√≠ndex de la documentaci√≥
          echo "# üìö Documentaci√≥ Pydoc" > docs/index.html
          for f in docs/*.html; do
            name=$(basename "$f")
            echo "- [$name]($name)" >> docs/index.html
          done

      - name: Publica a GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: docs

      - name: Actualitza README.md amb enlla√ß a la doc
        run: |
          LINK="[üìö Documentaci√≥ Pydoc](https://OriolTorraTudela.github.io/Projecte-Final_Django/)"
          if ! grep -q "Documentaci√≥ Pydoc" README.md; then
            echo -e "\n$LINK" >> README.md
            git config --global user.name "github-actions"
            git config --global user.email "github-actions@github.com"
            git add README.md
            git commit -m "Afegit enlla√ß a la documentaci√≥ Pydoc"
            git push origin main
          fi
