name: Projecte Django â€“ Oriol Torra

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-doc:
    runs-on: ubuntu-latest

    steps:
      - name: Clona el repositori
        uses: actions/checkout@v3

      - name: InstalÂ·la Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: InstalÂ·la dependÃ¨ncies
        run: |
          python -m pip install --upgrade pip
          pip install Django

      - name: Aplica les migracions
        run: |
          python manage.py migrate

      - name: Executa els tests
        run: |
          python manage.py test

      - name: Genera documentaciÃ³ HTML amb Pydoc
        run: |
          mkdir -p docs
          # Genera un HTML per a cada mÃ²dul .py
          for file in $(find . -name "*.py" ! -path "./venv/*" ! -path "./*/migrations/*"); do
            module_path=$(echo "$file" | sed 's|^\./||; s|/|.|g; s|\.py$||')
            echo "Generant doc per $module_path"
            python -m pydoc -w "$module_path" || echo "Error amb $module_path, saltant..."
          done
          # Mou tots els .html de la carpeta arrel a docs/
          mv *.html docs/ || true
          # Crea un index.html amb enllaÃ§os
          cat > docs/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>ðŸ“š DocumentaciÃ³ Pydoc</title></head>
<body>
<h1>ðŸ“š DocumentaciÃ³ Pydoc</h1>
<ul>
EOF
          for f in docs/*.html; do
            fname=$(basename "$f")
            echo "  <li><a href=\"$fname\">$fname</a></li>" >> docs/index.html
          done
          echo "</ul></body></html>" >> docs/index.html

      - name: Publica documentaciÃ³ a GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs
          publish_branch: gh-pages

      - name: Actualitza enllaÃ§ al README.md
        run: |
          DOC_LINK="[ðŸ“š DocumentaciÃ³ Pydoc](https://OriolTorraTudela.github.io/Projecte-Final_Django/)"
          if ! grep -q "DocumentaciÃ³ Pydoc" README.md; then
            echo -e "\n$DOC_LINK" >> README.md
          fi
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git diff --cached --quiet || git commit -m "Actualitzat README amb enllaÃ§ a la documentaciÃ³"
          git push origin main
