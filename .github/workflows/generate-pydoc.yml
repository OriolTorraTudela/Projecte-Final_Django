# .github/workflows/generate-pydoc.yml
name: Projecte Django ‚Äì Oriol Torra

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-doc:
    runs-on: ubuntu-latest

    steps:
      - name: Clona el repositori
        uses: actions/checkout@v3

      - name: Instal¬∑la Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Instal¬∑la depend√®ncies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Aplica les migracions
        run: |
          python manage.py migrate

      - name: Executa els tests
        run: |
          python manage.py test

      - name: Genera documentaci√≥ HTML amb Pydoc
        env:
          DJANGO_SETTINGS_MODULE: my_site.settings
          PYTHONPATH: ${{ github.workspace }}
        run: |
          mkdir -p docs
          for file in $(find . -name "*.py" ! -path "./venv/*" ! -path "./*/migrations/*"); do
            module_path=$(echo "$file" | sed 's|^\./||' | sed 's|/|.|g' | sed 's|\.py$||')
            echo "Generant doc per $module_path"
            pydoc -w "$module_path" || echo "Error amb $module_path, saltant..."
          done
          mv ./*.html docs/ || true

          # Crea index.html amb enlla√ßos a tots els HTML generats
          cat > docs/index.html << 'EOF'
üìö Documentaci√≥ Pydoc
EOF
          for f in docs/*.html; do
            fname=$(basename "$f")
            echo "- [$fname]($fname)" >> docs/index.html
          done

      - name: Publica documentaci√≥ a GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: docs

      - name: Actualitza enlla√ß al README.md sense duplicats
        run: |
          DOC_LINK="[üìö Documentaci√≥ Pydoc](https://OriolTorraTudela.github.io/Projecte-Final_Django/)"
          if [ ! -f README.md ]; then
            echo -e "# Projecte-Final_Django\n\n$DOC_LINK" > README.md
          else
            sed -i '/Documentaci√≥ Pydoc/d' README.md
            echo -e "\n$DOC_LINK" >> README.md
          fi
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add README.md
          git diff --cached --quiet || git commit -m "Actualitzat README amb enlla√ß a la documentaci√≥"
          git push origin main
